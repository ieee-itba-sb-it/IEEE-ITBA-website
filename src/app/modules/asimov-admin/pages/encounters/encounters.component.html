<div class="encounters-admin">
  <mat-form-field appearance="fill">
    <mat-label>Seleccionar categoría</mat-label>
    <mat-select [(ngModel)]="selectedCategory" (selectionChange)="onCategoryChange($event.value)" name="category">
      <mat-option [value]="null">-- Selecciona una categoría --</mat-option>
      <mat-option *ngFor="let cat of (categories$ | async)" [value]="cat">{{ cat.name }}</mat-option>
    </mat-select>
  </mat-form-field>

  <div *ngIf="selectedCategory">
    <h3>Enfrentamientos iniciales para {{ selectedCategory.name }}</h3>
    <form #addEncounterForm="ngForm" (ngSubmit)="addInitialEncounter(selectedRobot1, selectedRobot2)" class="encounter-form">
      <mat-form-field appearance="fill">
        <mat-label>Robot 1</mat-label>
        <mat-select [(ngModel)]="selectedRobot1" name="robot1" required>
          <mat-option [value]="null">-- Selecciona un robot --</mat-option>
          <mat-option *ngFor="let robot of (robots$ | async)" [value]="robot">{{ robot.name }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field class="ml-4" appearance="fill">
        <mat-label>Robot 2</mat-label>
        <mat-select [(ngModel)]="selectedRobot2" name="robot2" required>
          <mat-option [value]="null">-- Selecciona un robot --</mat-option>
          <mat-option *ngFor="let robot of (robots$ | async)" [value]="robot">{{ robot.name }}</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="!selectedRobot1 || !selectedRobot2 || selectedRobot1.id === selectedRobot2.id">Agregar enfrentamiento</button>
    </form>

    <div *ngIf="encountersList.length > 0">
      <h4>Enfrentamientos por ronda</h4>
      <div *ngFor="let level of getLevels()">
        <h5>Ronda {{ level }}</h5>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Robot 1</th>
              <th>Robot 2</th>
              <th>Ganador</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let encounter of getEncountersByLevel(level)">
              <td>{{ encounter.order }}</td>
              <td>{{ getRobotName(encounter.robot1) }}</td>
              <td>{{ getRobotName(encounter.robot2) }}</td>
              <td>
                <ng-container *ngIf="encounter.robot1 && encounter.robot2; else pendiente">
                  <button [disabled]="encounter.winner === 1" (click)="setWinner(encounter, encounter.robot1)">
                    {{ getRobotName(encounter.robot1) }}
                  </button>
                  <button [disabled]="encounter.winner === 2" (click)="setWinner(encounter, encounter.robot2)">
                    {{ getRobotName(encounter.robot2) }}
                  </button>
                  <span *ngIf="encounter.winner">Ganador: {{ getRobotName(encounter.winner === 1 ? encounter.robot1 : encounter.robot2) }}</span>
                </ng-container>
                <ng-template #pendiente>
                  <span>Pendiente</span>
                </ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <button mat-stroked-button color="primary" class="ml-4" (click)="saveEncounters(robotsList)" [disabled]="loading || encountersList.length === 0">Guardar enfrentamientos</button>
    <div *ngIf="loading">Guardando...</div>
    <div *ngIf="error" class="error">{{ error }}</div>
  </div>
</div>
